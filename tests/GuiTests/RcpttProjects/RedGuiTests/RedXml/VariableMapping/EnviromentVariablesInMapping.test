--- RCPTT testcase ---
Format-Version: 1.0
Contexts: _PWaRoCtqEeikWYhBbRs9Qw
Element-Name: EnviromentVariablesInMapping
Element-Type: testcase
Element-Version: 3.0
External-Reference: 
Id: _wbtl8CtnEeikWYhBbRs9Qw
Runtime-Version: 2.4.3.201909171500
Save-Time: 3/4/20 2:53 PM
Testcase-Type: ecl

------=_.content-0a7243a0-75d3-3d5f-9791-539de0e5b7ac
Content-Type: text/ecl
Entry-Name: .content

//open file and check QF for enviroment variables
get-view Problems | click
wait-for-errors -amount 5 -times 6 -delay 500
get-view "Project Explorer" | get-tree | select "EnvVars/TestFile.robot" | double-click
with [get-editor "TestFile.robot" | get-text-viewer] {
    hover-text 2 19
    set-caret-pos 2 18
    key-type "M1+1"
}
// add folder name
wait 200
get-window -from "CompletionProposalPopup.createProposalSelector()" | get-table 
    | select "Define '%{res_folder}' variable" | click -default
with [get-window "Add variable mapping"] {
    get-editbox -after [get-label Value] | type-text res
    get-button OK | click
}

//check if new variable is added
with [get-editor "EnvVars/red.xml" | get-section "Variable mappings" | get-table] {
    get-property "getItems().length" | equals 4 | verify-true
    get-property "getItems().TableItem[0].getData().getName()" | equals "%{my_var}" | verify-true
    get-property "getItems().TableItem[0].getData().getValue()" | equals "var1.py" | verify-true
    
    get-property "getItems().TableItem[1].getData().getName()" | equals "%{res2}" | verify-true
    get-property "getItems().TableItem[1].getData().getValue()" | equals "%{res_folder}/res2.robot" | verify-true
    
    get-property "getItems().TableItem[2].getData().getName()" | equals "%{res_folder}" | verify-true
    get-property "getItems().TableItem[2].getData().getValue()" | equals res | verify-true
    
    get-property "getItems().TableItem[3].getText()" | equals "...add new mapping" | verify-true
}

//add variable in red.xml
with [get-editor "EnvVars/red.xml"] {
    click
    get-section "Variable mappings" | get-table | get-item "...add new mapping" | double-click
}

//add full path
with [get-window "Add variable mapping"] {
    get-editbox -after [get-label Name] | type-text "%{my_lib1}"
    with [get-editbox -after [get-label Value]] {
        set-text-offset 5 0
        key-type BackSpace -times 5
        type-text [concat $RED_workspace_path_unix_style "/EnvVars/lib/lib1.py"]
    }
    get-button OK | click
}

get-button "Save All (M1+M2+S)" | click
get-editor "TestFile.robot" | click
get-menu -path "Project/Clean..." | click
get-window Clean | get-button Clean | click

//save and check that is one error for lib
get-view Problems | click
get-view Problems | get-tree | get-item 
    -path "Errors \\(3 items\\)/Unknown '.*' library. Try to use Quick Fix \\(Ctrl\\+1\\) or add library to red.xml for proper validation" 
    | get-property caption 
    | equals [format "Unknown '%s/EnvVars/lib/lib1.py' library. Try to use Quick Fix (Ctrl+1) or add library to red.xml for proper validation" $RED_workspace_path_unix_style]
    | verify-true

//use QF to autodiscover lib 
get-view "Project Explorer" | get-tree | select "EnvVars/TestFile.robot"
with [get-editor "TestFile.robot" | get-text-viewer] {
    hover-text 3 17
    set-caret-pos 3 19
    key-type "M1+1"
}
get-window -from "CompletionProposalPopup.createProposalSelector()" | get-table 
    | select "Discover '.*\\/EnvVars\\/lib\\/lib1.py' and add to configuration" | click 
    -default
    
//check that lib was added to red.xml    
with [get-editor "EnvVars/red.xml" | get-section Libraries | get-tree] {
    get-property "getItems().TableItem[1].getText()" | equals "lib1 - EnvVars/lib/lib1.py" | verify-true
    get-property "getItems().TableItem[2].getText()" | equals "...add new library file" | verify-true
}
get-button "Save (M1+S)" | click


//check that variable definde below is not visible
with [get-editor "TestFile.robot"] {
    click
    with [get-text-viewer] {
        set-caret-pos 5 7
        key-type "M1+/"
        key-type "M1+s"
    }
}

wait-for-errors -amount 2 -times 5 -delay 500
get-view Problems | get-tree | get-item 
    -path "Errors \\(2 items\\)/'%{res2}' contains unresolved import parameters.  Use Variable mappings in red.xml for parameter resolution" 
    | get-property caption 
    | equals "'%{res2}' contains unresolved import parameters.  Use Variable mappings in red.xml for parameter resolution" 
    | verify-true
    
// go to red.xml and remove res2    
get-editor "EnvVars/red.xml"| click
get-editor "EnvVars/red.xml" | get-tab-folder | get-tab-item Variables | click
with [get-editor "EnvVars/red.xml" | get-section "Variable mappings"| get-table] {
    select "%{res2}" | key-type Del
    get-item "...add new mapping" | double-click
}

//add one more time by at the and of file
with [get-window "Add variable mapping"] {
    get-editbox -after [get-label Name] | type-text "%{res2}"
    with [get-editbox -after [get-label Value]] {
        key-type Del -times 5
        type-text "%{res_folder}/res2.robot"
    }
    get-button OK | click
}
//add new default var and add to value env var
get-editor "EnvVars/red.xml" | get-section "Variable mappings" | get-table | get-item "...add new mapping" | double-click
with [get-window "Add variable mapping"] {
    with [get-editbox -after [get-label Value]] {
        key-type Del -times 5
        type-text "%{my_var}"
    }
    get-button OK | click
}

//change env vRIBALE TO normal variable and make mistake to check path
get-button "Save All (M1+M2+S)" | click
with [get-editor "TestFile.robot"] {
    click
    with [get-text-viewer] {
        set-caret-pos 4 24
        key-type BackSpace -times 5
        type-text "${"
        set-caret-pos 4 18
        type-text 2
        key-type "M1+s"
    }
}
wait-for-errors -amount 2 -times 4 -delay 500
get-view Problems | get-tree | get-item 
    -path "Errors \\(2 items\\)/Resource import 'vars2\\/var1.py' is invalid: file does not exist. Check file name and path." 
    | get-property caption 
    | equals "Resource import 'vars2/var1.py' is invalid: file does not exist. Check file name and path." | verify-true
    
------=_.content-0a7243a0-75d3-3d5f-9791-539de0e5b7ac--
